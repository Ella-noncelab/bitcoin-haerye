# 4장. 키와 주소 <!-- omit in toc -->

> 📖 원문: [Mastering Bitcoin 2nd Endition - Chapter 04. Key, Addresses ](https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch04.asciidoc)

### 목차

- [개요](#개요)
- [공개키 암호학과 암호화폐](#공개키-암호학과-암호화폐)
- [개인키와 공개키](#개인키와-공개키)
- [개인키](#개인키)
  - [난수에서 개인키 생성하기](#난수에서-개인키-생성하기)
- [공개키](#공개키)
- [타원 곡선 암호학(Elliptic curve cryptography)](#타원-곡선-암호학elliptic-curve-cryptography)
- [공개키 생성하기](#공개키-생성하기)
- [비트코인 주소](#비트코인-주소)
  - [Base58과 Base58Check 인코딩](#base58과-base58check-인코딩)
- [키 포맷](#키-포맷)
  - [개인키 포ㅅ](#개인키-포ㅅ)
  - [Base58Chck](#base58chck)

---

- 비트코인은 수학의 한 분야인 암호학(cryptography)을 기반으로 한다. 
- 그리스어로 원문을 감추는 비밀 글쓰기(secret writing)를 뜻하고 이를 암호화(encryption)라 한다. 
- 이 외에도 비밀을 드러내지 않고 비밀을 알고 있음을 증명하는 디지털 서명(digital signature), 데이터의 진위(digital fingerprint)를 증명하는데에도 사용된다. - 이 장에서는 키, 주소 및 지갑의 형태로 자금 소유권을 제어하기 위해 비트코인에 사용되는 암호학을 소개한다. 

## 개요

- 비트코인의 소유권을 확립하기 위해서는 디지털 키, 비트코인 주소, 디지털 서명이 필요하다.
- 디지털 키는 네트워크에 보관되는 것이 아니라 사용자 지갑 속에 저장된다.
- 사용자 지갑 속 디지털 키는 비트코인 프로토콜과 완전 독립적인 것으로, 블록체인이나 인터넷 접속 없이도 사용자 지갑 소프트웨어로 생성하고 관리할 수 있다. 

- 대부분 비트코인 거래에는 디지털 서명이 필요하다.
- 금액을 소비하기 위해 사용되는 디지털 서명을 암호학 용어로 증인(witness)라고 한다. 
- 키는 개인키와 공개키 한 쌍으로 구성된다. 공개키는 은행의 계좌번호와, 개인키는 계좌의 비밀번호와 유사하다.
    - 공개키 : 비트코인 주소를 만들 때 사용된다.
    - 개인키 : 거래 시 디지털 서명에 사용된다.

## 공개키 암호학과 암호화폐

- 공개키 암호학은 1970년대에 발명되어 컴퓨터와 정보 보안의 토대가 되었다.
- 공개키 암호학의 발명 이후 소수지수 함수, 타원곡선 곱셈 함수 등 적합한 수학 함수가 발견되었다.
- 이러한 함수들의 특징은 불가역적(irreversible)이라는 것인데 다시 말해, 한 방향으로 계산하는 것은 쉽지만 반대 방향으로 계산하는 것은 실행 불가능함을 의미한다. 
- 불가역적 함수 기반의 암호학은 유추할 수 없는 비밀키와 위조 불가능한 디지털 서명을 가능하게 한다. 

- 비트코인에 접근하는 권한을 주는 한 쌍의 키를 생성하는데에 공개키 암호학이 사용된다.
- 한 쌍의 키는 개인키와 개인키로부터 파생된 고유한 공개키로 구성된다. 
- 공개키는 비트코인을 전송받을 때, 개인키는 전송받은 비트코인을 소비할 때 디지털 서명을 위해 사용된다.
- 공개키 암호학의 수학적 관계 때문에, 개인키를 사용하여 서명하고, 개인키 노출 없이 공개키만으로 유효성을 확인할 수 있다.

## 개인키와 공개키

- 개인키는 소문자 k로 표기하고 대개 무작위 추출된 숫자이다.
- 불가역성을 갖는 단방향 함수인 타원곡선 곰셈 함수를 이용하여 개인키(k)로부터 공개키(K)를 계산한다.
- 이 장에서는 개인키 생성, 개인키로부터 공개키 계산, 공개키로부터 비트코인 주소를 생성하는 과정을 설명한다. 

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0401.png" width="500">
    <br>
      그림 1. 개인키, 공개키, 비트코인 주소의 관계
  </figure>

## 개인키

- 개인키는 무작위로 추출된 256비트 길이의 숫자이다. 
- 개인키의 소유권 및 통제권은 개인키를 보유한 당사자에게 있고, 이 개인키로부터 추출된 비트코인 주소와 연관된 모든 자금에 대한 권한을 갖는다.
- 따라서 제 3자에게 개인키를 공개하는 것은 모든 비트코인에 대한 통제권을 넘겨주는 것과 같다.

### 난수에서 개인키 생성하기

- 키를 생성하는 과정 중 가장 중요한 첫 단계는 *보안이 철저한 엔트로피* 또는 무작위성(randomness)을 찾는 것이다.
- 중요한 것은 여러분이 선택한 숫자가 예측 또는 재현 가능하지 않으면 된다. 
- 비트코인 소프트웨어는 운영체제의 *난수 생성기(random number generator)*로 256비트 엔트로피를 만든다.
- 256비트 개인키는 16진법 형식으로 표현된다.
  ```1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD``` 


  > 💡 암호학적으로 안전한 유사난수생성기(CSPRNG) 사용하기
  >
  > 난수 생성을 위해 자체 코드를 사용하거나 프로그래밍 언어가 제공하는 단순한 난수생성기를 사용하면 안된다. 암호학적으로 안전한 유사난수생성기(Cryptographically secure pseudorandom number generator)를 사용하는 것이 중요하다. 키의 보안성에 있어 올바른 CSPRNG를 구현하는 것이 중요하다.

  > 💡 2<sup>256</sup>의 의미
  >
  > 2<sup>256</sup>은 10진법으로 표시하면 10<sup>77</sup> 정도이다. </br>
  > 비교하자면 가시적인 우주는 10<sup>80</sup>개의 원자로 구성되어 있다고 추정된다.

## 공개키

- 공개키는 타원곡선 곱셈 함수를 이용하여 개인키로부터 계산되고 그 과정을 거꾸로 진행할 수는 없다.
  </br>
  ```K = k * G```
- k는 개인키이다. 
- G는 상수로 생성점(Generator point)이라 한다.
- * 연산은 단순 곱셈이 아닌 타원곡선의 점 곱셈(point multiplication)이다. 
- k * G의 계산 결과가 공개키 K이다. 

## 타원 곡선 암호학(Elliptic curve cryptography)

- 타원 곡선 암호학은 이산로그(discrete logarithm) 문제를 기반으로 한다. 
- 이산로그 문제는 한 방향으로의 계산은 쉬우나 반대방향으로의 계산은 불가능한 트랩 도어(trapdoor) 함수의 일종이다. 
- 타원 곡선 위의 점 덧셈(point addition)이나 점 곱셈(point multiplication)으로 표현된다.
- 그림은 타원 곡선의 한 예로 비트코인에서 사용하는 것과 유사하다. 

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0402.png" width="350">
    <br>
      그림 1. 타원 곡선의 예
  </figure>


- 비트코인은 미국립표준기술원(NIST)에서 개발한 secp256k1 표준을 사용한다.
- secp256k1은 아래 함수로 정의된다.
  $$
  \begin{aligned}
   & y^{2} = (x^3 + 7 ) \ over \ (F_p) \\
   & y^{2} \ mod \ p = (x^3 + 7 ) \ mod \ p 
  \end{aligned}$$
- $p$를 소수위수(prime order)라 하며 $p = 2^{256} - 2^{32} - 2^9 - 2^8 - 2^6 - 2^4 -1$로 매우 큰 소수이다. 
- 함수 식에서 볼 수 있는 것처럼 $mod \ p$ 연산에 의해 이 곡선은 p의 유한체(finite field, $F$) 체제 내에 존재한다. ($over \ F_p$ 또는 $F(p)$)
- 다만 이 곡선은 실수 체제가 아닌 소수위수 체제에서 정의되므로 2차원 그래프에 분포한 점들로 표현되어 시각화하기가 쉽지 않다. 
- secp256k1 타원 곡선의 경우 헤아릴 수 없이 큰 격자 위에 훨씬 더 복잡한 패턴으로 점이 찍혀있는 형태를 생각해볼 수 있다. 

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0403.png" width="350">
    <br>
      그림 2. p=17인 경우, F(p)에 대한 타원 곡선의 시각화
  </figure>

- 아래는 secp256k1 곡선 위의 한 점의 좌표 P를 나타낸다.
  ```
  P = (55066263022277343669578718895168534326250603453777594175500187360389116729240, 32670510020758816978083085130507043184471273380659243275938904335757337482424)
  ```
- 타원 곡선 함수에는 무한원점(point at infinity)라는 점이 있는데, 이는 덧셈에서 0의 역할(항등원)과 유사하다.
- 타원 곡선에는 덧셈 연산자가 있다. (+)
- 타원 곡선 위의 두 점 P<sub>1</sub>, P<sub>2</sub>에 대해 곡선 위에 존재하는 또 다른 점 P<sub>3</sub> = P<sub>1</sub> + P<sub>2</sub>가 존재한다.
- 타원 곡선의 점 덧셈은 기하학적으로 P<sub>1</sub>과 P<sub>2</sub>를 잇는 직선이 타원곡선과 만나는 교차점 P<sub>3</sub>' = (x, y)를 x축에 대칭시킨 점 P<sub>3</sub> = (x, -y)로 얻는다. 
- P<sub>1</sub>과 P<sub>2</sub>가 동일한 점인 경우, P<sub>1</sub>과 P<sub>2</sub>를 잇는 직선은 곡선과 P<sub>1</sub>의 접선이 된다. 
- 같은 방식은 2P = P + P, 3P = 2P + P ... 를 구할 수 있다. 
- 이것은 결국 타원 곡선의 점 곱셈을 정의한다. k * P는 점 P를 k번 점 덧셈한 결과이다.



## 공개키 생성하기

- 무작위로 생성된 숫자 k, 즉 개인키를 출발점으로 곡선 위 미리 정해진 값 G(생성점)를 곱한 결과가 공개키 K이다. 
- 앞서 본 것처럼 계산은 한 방향으로만 가능하기 때문에 개인키는 공개키를 만들 수 있지만, 공개키로 개인키를 역산할 수 없다.
- 생성점 G는 상수로 secp256k1을 사용하는 사용자는 모두 동일한 값을 사용한다.
- G는 아래와 같은 좌표이다. (04는 비압축 형태를 의미하며, 79BE667E ~ 16F81798가 x좌표를 나타낸다. 이하 y 좌표이다.)
  ```
  G = 
  04 
  79BE667E F9DCBBAC 55A06295 CE870B07 029BFCDB 2DCE28D9 59F2815B 16F81798 
  483ADA77 26A3C465 5DA4FBFC 0E1108A8 FD17B448 A6855419 9C47D08F FB10D4B8
  ```
- 앞서 생성한 개인키 k에 생성점 G를 곱해서 공개키 K를 구할 수 있다.
  ```
  K = 1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD * G
  ```
- 공개키 K도 타원 곡선 위의 한 점으로 정의된다. 
  ```
  K = (x, y)

  where,

  x = F028892BAD7ED57D2FB57BF33081D5CFCF6F9ED3D3D7F159C2E2FFF579DC341A
  y = 07CF33DA18BD734C600B96A72BBC4749D5141C90EC8AC328AE52DDFE2E505BDB
  ```

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0404.png" width="350">
    <br>
      그림 3. 타원 곡선 암호학: 곡선 위 점 G와 k의 곱을 시각화한 그림
    <br>
      (출처: https://blog.somi.me/math/2019/06/10/understanding-ECC-ECDSA/)
  </figure>

## 비트코인 주소

- 비트코인 주소는 공개키로부터 단방향 암호화를 통해 만들어낸다. 
- 여기에는 SHA256과 RIPEMD160 해시가 사용되며 그 결과 160비트의 숫자가 생성된다.
  ```
  A = RIEMD160(SHA256(K)), K는 공개키
  ```
- 결과값 A는 거의 항상 Base58Check로 인코딩된다.

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0405.png" width="500">
    <br>
      그림 4. 공개키를 비트코인 주소로 변환하는 과정
  </figure>

### Base58과 Base58Check 인코딩

- Base58은 소문자 26개, 대문자 26개, 숫자 10개, 두 개의 특수문자 '+', '/' 총 64개의 문자(Base64) 중 가독성을 저해하는 4개의 문자(0 숫자 영, O 대문자 오, l 소문자 엘, I 대문자 아이)와 특수문자(+, -)를 제외한 58개의 문자를 기반으로하는 2진법 인코딩 포맷이다.
- Base58Check는 오타, 데이터 입력 오류 등에 대한 추가적인 보안을 강화하기 위해 _오류 검사 코드가 내장되어 있는_ Base58 인코딩 포맷이다. 
- 오류 검사 코드, 체크섬은 데이터의 해시로부터 파생된 4바이트로 데이터 뒤에 추가된다.
- 데이터를 Base58Check 포맷으로 전환하기 위해서는 버전 바이트(version byte)라 불리는 접두부를 붙인다. 접두부 결과값이 특정 문자를 포함하기 때문에 데이터 유형을 쉽게 알아볼 수 있다.

  | 유형 | 버전 접두부(16진수) | Base58 접두부 결과값 |
  | --- | ---------------- | ----------------- |
  | 비트코인 주소             | 0x00  | 1         | 
  | Pay-to-Script-Address  | 0x05  | 3         |
  | 비트코인 테스트넷 주소      | 0x6F  | m 혹은 n   | 
  | 개인키 WIF              | 0x80  | 5, K 혹은 L | 
  | BIP-38 암호화 개인키      | 0x0142 | 6P       |
  | BIP-32 확장 공개키       | 0x0488B21E | xpub |

- 체크섬은 접두부와 데이터를 두 번 SHA256한 32바이트 결과값의 첫 4바이트만을 사용한다. 
  ```
  checksum = SHA256(SHA256(prefix + data))
  ```
- 최종 결과값은 접두부, 데이터, 체크섬으로 구성된다. 이 값을 Base58 인코딩한다. 

  <figure>
    <img src="https://github.com/bitcoinbook/bitcoinbook/raw/develop/images/mbc2_0406.png" width="500">
    <br>
      그림 4. Base58Check 인코딩: 
    <br>
      비트코인 데이터를 모호하지 않게 인코딩하기 위한 Base58, 버전 및 체크섬 형식
  </figure>

## 키 포맷

### 개인키 포맷
===== Private key formats

### Base58Check를 16진법으로 디코딩하기
===== Decode from Base58Check

### 16진법에서 Base58Check로 인코딩하기
===== Encode from hex to Base58Check

### 압축키 16진법에서 Base58Check로 인코딩하기
===== Encode from hex (compressed key) to Base58Check

### 공개키 포맷
===== Public key formats

### 압축 공개키
===== Compressed public keys

### 압축 개인키
===== Compressed private keys

## 고급키와 주소
=== Advanced Keys and Addresses

### 다중서명 주소와 P2SH
===== Multisignature addresses and P2SH

## 꾸미기 주소
==== Vanity Addresses

===== Generating vanity addresses

===== Vanity address security

==== Paper Wallets